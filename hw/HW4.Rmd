---
title: "Untitled"
author: "Neal Marquez"
date: "November 5, 2018"
output: pdf_document
---

```{r setup, message=FALSE, warning=FALSE}
rm(list=ls())
library(tidyverse)
library(mvtnorm)

anesDF <- "https://faculty.washington.edu/cadolph/mle/nes92con.csv" %>%
    read_csv

llk.oprobit.new <- function(param, formula, data){
    x <- model.matrix(formula[-2], data=data)
    y <- unlist(data[,all.vars(formula)[1]])
    yVals <- sort(unique(y))
    yMat <- sapply(yVals, function(xi) xi == y)
    b <- param[1:ncol(x)]
    xb <- x%*%b
    taus <- c(0, param[(ncol(x)+1):length(param)])
    pMatrix <- matrix(0, nrow=nrow(x), ncol=length(taus) + 1)
    i <- 1
    pMatrix[,i] <- log(pnorm(-xb))
    for(t in taus[2:length(taus)]){
        i <- i + 1
        tlag <- taus[i-1]
        if(t <= tlag){
            pMatrix[,i] <- -(abs(t)*10000) 
        }
        else{
            pMatrix[,i] <- log(pnorm(t-xb)-pnorm(tlag-xb))
        }
    }
    pMatrix[,i+1] <- log(1-pnorm(t-xb))

    -sum(pMatrix * yMat)
}

oprobit.fit <- function(formula, data){
    xN <- ncol(model.matrix(formula[-2], data=data))
    yN <- length(unique(unlist(data[,all.vars(formula)[1]])))
    tauStarts <- 1:(yN-2)
    names(tauStarts) <- paste0("tau", 2:(yN-1)) 

    pStart <- c(coef(lm(formula, data=data)), tauStarts)
    optFit <- optim(
        pStart,
        llk.oprobit.new,
        method = "BFGS",
        formula = formula,
        data = data,
        hessian = TRUE)
    optFit$formula <- formula
    optFit
}

modelPredict <- function(model, data, draws=NULL){
    x <- model.matrix(model$formula[-2], data=data)
    yN <- length(model$par) - ncol(x) + 2
    if(is.null(draws)){
        draws_ <- 1
        paramDraws <- matrix(model$par, nrow=draws_, ncol=length(model$par))
        xb <- x %*% paramDraws[,1:ncol(x)]
        tdraws <- matrix(
            c(0, paramDraws[,(ncol(x) + 1):length(model$par)]), ncol=1)
    }
    else{
        draws_ <- draws
        paramDraws <- rmvnorm(draws, model$par, solve(model$hessian))
        xb <- x %*% t(paramDraws[,1:ncol(x)])
        tdraws <- t(cbind(0, paramDraws[,(ncol(x) + 1):length(model$par)]))
    }
    pArray <- array(0, dim=c(nrow(x), yN, draws_))
    for(d in 1:draws_){
        taus <- tdraws[,d]
        i <- 1
        pArray[,i,d] <- pnorm(-xb[,d])
        for(t in taus[2:length(taus)]){
            i <- i + 1
            tlag <- taus[i-1]
            pArray[,i,d] <- pnorm(t-xb[,d])-pnorm(tlag-xb[,d])
        }
        pArray[,i+1,d] <- 1-pnorm(t-xb[,d])
    }
    if(is.null(draws)){
        pArray <- pArray[,,1]
    }
    pArray
}
```

# A
Use an ordered probit model to explain respondents approval of Bush. Using the `llk.oprobit()` function provided in class and `optim()`, fit the model to the variable _bushapp_ with _milforce_, _rbdist_, _econ_, _partyid_, and _yrsofed_ as the only covariates. Report the estimated parameters, their standard errors, and the value of the log likelihood at its maximum.

```{r}
fog <- bushapp ~ milforce + rbdist + econ + partyid + yrsofed
modelFit <- oprobit.fit(fog, na.omit(anesDF[,all.vars(fog)]))
cat(paste0("Log Likelihood at the maximum: ", round(-modelFit$value, 4)))
tibble(
    Parameter = names(modelFit$par),
    Estimate = modelFit$par,
    std.err = diag(solve(modelFit$hessian))
)

```

# B
Calculate the probabilities that a respondent who identified themselves as a strong Democrat ( _partyid_ = -3) said they "Strongly Disapproved", "Disapproved", "Approved", or "Strongly Approved" of President Bush given their support or opposition to military force ( _milforce_ = $\{1, 2, 3, 4, 5\}$), holding the remaining covariates at their mean values.  Calculate the probabilities again over the same range of responses for _milforce_ for a respondent who identified themselves as a strong Republican ( _partyid_ = 3). You should have two sets of 20 probabilities, or 40 probabilities total.

```{r}
na.omit(anesDF[,all.vars(fog)]) %>%
    select(-bushapp, -milforce, -partyid) %>%
    summarise_all(mean) %>%
    cbind(expand.grid(milforce=1:5, partyid=c(-3, 3))) %>%
    cbind(modelPredict(modelFit, .))
```

# C

Present the expected probabilities for each category you calculated in part b in a way that would not require your reader to know anything about ordered probit models. Be sure to present confidence intervals, in a fashion of your choosing.

```{r}
dataMat <- na.omit(anesDF[,all.vars(fog)]) %>%
    select(-bushapp, -milforce, -partyid) %>%
    summarise_all(mean) %>%
    cbind(expand.grid(milforce=1:5, partyid=c(-3, 3)))

simArray <- modelPredict(modelFit, dataMat, draws = 1000)

bind_rows(lapply(1:4, function(x) dataMat)) %>%
    mutate(bushapp=rep(1:4, each=nrow(dataMat))) %>%
    mutate(prob=c(apply(simArray, c(1,2), mean))) %>%
    mutate(plwr=c(apply(simArray, c(1,2), quantile, probs=.025))) %>%
    mutate(pupr=c(apply(simArray, c(1,2), quantile, probs=.975))) %>%
    mutate(bushapp=as.factor(bushapp)) %>%
    mutate(Politics=if_else(
        partyid == 3, 
        "Strongly Republican",
        "Strongly Democrat")) %>%
    ggplot(aes(
        x=milforce, y=prob, group=bushapp, fill=bushapp, color=bushapp,
        ymin=plwr, ymax=pupr)) +
    geom_line() +
    geom_ribbon(alpha=.2) +
    theme_classic() +
    facet_wrap(~Politics) +
    labs(color="Bush\nApproval", fill="Bush\nApproval",
         x="Military Force Support", y="Probability")
```